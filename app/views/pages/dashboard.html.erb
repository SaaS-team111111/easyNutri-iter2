<h1>Easy-Nutri Dashboard</h1>

<div class="dashboard-container">
  <div class="action-buttons">
    <%= link_to "Create User", new_user_path, class: "button button-primary" %>
    <%= link_to "Create Meal Plan", new_meal_plan_path, class: "button button-success" %>
  </div>

  <div class="user-selector">
    <h2>View User's Meal Plans</h2>
    
    <% if @users.any? %>
      <%= form_with url: root_path, method: :get, local: true, class: "select-form" do |f| %>
        <%= f.select :user_id, 
            options_from_collection_for_select(@users, :id, :name, params[:user_id]), 
            { prompt: "Select a user..." },
            { class: "user-select", onchange: "this.form.submit();" } %>
      <% end %>
      
      <% if @selected_user %>
        <div class="user-meal-plans">
          <h3><%= @selected_user.name %>'s Meal Plans</h3>
          
          <% if @current_meal_plan %>
            <table>
              <thead>
                <tr>
                  <th>Goal</th>
                  <th>Duration</th>
                  <th>Status</th>
                  <th>Current Day</th>
                  <th>Created</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td><%= @current_meal_plan.goal %></td>
                  <td><%= @current_meal_plan.duration_days %> days</td>
                  <td><span class="badge"><%= @current_meal_plan.status %></span></td>
                  <td><strong>Day <%= @current_day_number %> of <%= @total_days %></strong></td>
                  <td><%= @current_meal_plan.created_at.strftime("%Y-%m-%d") %></td>
                  <td>
                    <%= link_to "View Details", meal_plan_path(@current_meal_plan), class: "link" %>
                  </td>
                </tr>
              </tbody>
            </table>

            <% if @current_meal_plan.completed? %>
              <div class="completed-section">
                <p class="info-message">This meal plan has been completed.</p>
                <%= link_to "Create New Meal Plan", new_meal_plan_path, class: "button button-success" %>
              </div>
              
              <div id="completionModal" class="modal" <% if @just_completed %>style="display: block;"<% end %>>
                <div class="modal-content completion-modal">
                  <div class="celebration-icon">ðŸŽ‰ðŸŽ‰ðŸŽ‰</div>
                  <h2>Congratulations!</h2>
                  <p class="completion-message">You've successfully completed your meal plan!</p>
                  <div class="modal-actions">
                    <button type="button" class="button button-success button-large" onclick="closeAndRedirect()">OK</button>
                  </div>
                </div>
              </div>
            <% else %>
              <div class="today-section">
                <h3>Today's Recommended Menu (Day <%= @current_day_number %>)</h3>
                
                <% if @today_meals.any? %>
                  <table class="meals-table">
                    <thead>
                      <tr>
                        <th>Meal Type</th>
                        <th>Food</th>
                        <th>Amount (g)</th>
                        <th>Calories</th>
                        <th>Protein (g)</th>
                        <th>Carbs (g)</th>
                        <th>Fat (g)</th>
                      </tr>
                    </thead>
                    <tbody>
                      <% %w[breakfast lunch dinner].each do |meal_type| %>
                        <% if @today_meals[meal_type].present? %>
                          <% @today_meals[meal_type].each do |entry| %>
                            <tr>
                              <td class="meal-type"><%= meal_type.titleize %></td>
                              <td><%= entry.food_item.name %></td>
                              <td><%= entry.grams %>g</td>
                              <td><%= ((entry.food_item.calories_per_100g * entry.grams) / 100.0).round %></td>
                              <td><%= ((entry.food_item.protein_per_100g * entry.grams) / 100.0).round(1) %></td>
                              <td><%= ((entry.food_item.carbs_per_100g * entry.grams) / 100.0).round(1) %></td>
                              <td><%= ((entry.food_item.fat_per_100g * entry.grams) / 100.0).round(1) %></td>
                            </tr>
                          <% end %>
                        <% end %>
                      <% end %>
                    </tbody>
                  </table>

                  <div class="next-day-button">
                    <button type="button" class="button button-next" onclick="handleNextDay()">
                      Next Day â†’
                    </button>
                  </div>
                <% else %>
                  <p class="no-data">No meals found for today.</p>
                <% end %>
              </div>
            <% end %>
          <% else %>
            <p class="no-data">No active meal plan for this user. <%= link_to "Create one now", new_meal_plan_path, class: "link" %>.</p>
          <% end %>
        </div>
      <% end %>
    <% else %>
      <p class="no-data">No users yet. Please create a user first.</p>
    <% end %>
  </div>
</div>

<% if @current_meal_plan && !@current_meal_plan.completed? %>
  <div id="feedbackModal" class="modal">
    <div class="modal-content">
      <h3>How did you follow today's meal plan?</h3>
      <p>Your feedback helps us optimize future recommendations.</p>
      
      <%= form_with url: advance_day_meal_plan_path(@current_meal_plan), method: :post, local: true, class: "feedback-form" do |f| %>
        <div class="feedback-options">
          <button type="submit" name="feedback" value="strictly_followed" class="feedback-button">
            <strong>Followed Strictly</strong>
            <small>I followed the meal plan exactly</small>
          </button>
          
          <button type="submit" name="feedback" value="less_healthy" class="feedback-button">
            <strong>Ate Less Healthy</strong>
            <small>I consumed less healthy foods</small>
          </button>
          
          <button type="submit" name="feedback" value="more_healthy" class="feedback-button">
            <strong>Ate Healthier</strong>
            <small>I consumed healthier foods</small>
          </button>
        </div>
      <% end %>
      
      <button type="button" class="button button-cancel" onclick="hideFeedbackModal()">Cancel</button>
    </div>
  </div>
<% end %>

<style>
  .dashboard-container {
    max-width: 1000px;
    margin: 0 auto;
    padding: 20px;
  }
  
  h1 {
    color: #333;
    margin-bottom: 30px;
  }
  
  .action-buttons {
    display: flex;
    gap: 15px;
    margin-bottom: 40px;
  }
  
  .button {
    display: inline-block;
    padding: 12px 24px;
    text-decoration: none;
    border-radius: 6px;
    font-size: 16px;
    font-weight: 600;
    transition: all 0.3s;
    border: none;
    cursor: pointer;
  }
  
  .button-primary {
    background-color: #007bff;
    color: white;
  }
  
  .button-primary:hover {
    background-color: #0056b3;
  }
  
  .button-success {
    background-color: #28a745;
    color: white;
  }
  
  .button-success:hover {
    background-color: #218838;
  }
  
  .button-next {
    background-color: #007bff;
    color: white;
    font-size: 18px;
    padding: 14px 32px;
    margin-top: 20px;
  }
  
  .button-next:hover {
    background-color: #0056b3;
  }
  
  .button-cancel {
    background-color: #6c757d;
    color: white;
    margin-top: 15px;
  }
  
  .button-cancel:hover {
    background-color: #5a6268;
  }
  
  .user-selector {
    background-color: #f8f9fa;
    padding: 30px;
    border-radius: 8px;
  }
  
  .user-selector h2 {
    color: #333;
    margin-bottom: 20px;
  }
  
  .select-form {
    margin-bottom: 30px;
  }
  
  .user-select {
    width: 100%;
    max-width: 400px;
    padding: 10px;
    border: 2px solid #ddd;
    border-radius: 6px;
    font-size: 16px;
    cursor: pointer;
  }
  
  .user-select:focus {
    outline: none;
    border-color: #007bff;
  }
  
  .user-meal-plans {
    margin-top: 30px;
  }
  
  .user-meal-plans h3 {
    color: #007bff;
    margin-bottom: 20px;
  }
  
  table {
    width: 100%;
    border-collapse: collapse;
    background-color: white;
    border-radius: 6px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-bottom: 30px;
  }
  
  th, td {
    padding: 15px;
    text-align: left;
    border-bottom: 1px solid #ddd;
  }
  
  th {
    background-color: #007bff;
    color: white;
    font-weight: 600;
  }
  
  tr:last-child td {
    border-bottom: none;
  }
  
  tr:hover {
    background-color: #f8f9fa;
  }
  
  .badge {
    display: inline-block;
    padding: 4px 12px;
    background-color: #28a745;
    color: white;
    border-radius: 12px;
    font-size: 14px;
  }
  
  .link {
    color: #007bff;
    text-decoration: none;
  }
  
  .link:hover {
    text-decoration: underline;
  }
  
  .no-data {
    color: #666;
    font-style: italic;
    padding: 20px;
    text-align: center;
  }

  .today-section {
    margin-top: 30px;
    background-color: white;
    padding: 20px;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .today-section h3 {
    color: #333;
    margin-bottom: 20px;
  }

  .meals-table {
    margin-bottom: 20px;
  }

  .meals-table th {
    background-color: #007bff;
    color: white;
  }

  .meal-type {
    font-weight: 600;
    color: #28a745;
  }

  .next-day-button {
    text-align: center;
    padding-top: 20px;
    border-top: 2px solid #e9ecef;
  }

  .completed-section {
    text-align: center;
    padding: 30px 20px;
    background-color: white;
    border-radius: 6px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    margin-top: 30px;
  }

  .completed-section .info-message {
    color: #666;
    margin-bottom: 20px;
    font-size: 16px;
  }

  .completion-modal {
    max-width: 550px;
    text-align: center;
    padding: 40px;
  }

  .celebration-icon {
    font-size: 80px;
    margin-bottom: 20px;
    animation: bounce 1s ease infinite;
  }

  @keyframes bounce {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-20px); }
  }

  .completion-modal h2 {
    color: #28a745;
    font-size: 32px;
    margin-bottom: 15px;
  }

  .completion-message {
    color: #333;
    font-size: 18px;
    margin-bottom: 30px;
    line-height: 1.6;
  }

  .completion-stats {
    display: flex;
    justify-content: center;
    gap: 40px;
    margin-bottom: 30px;
    padding: 20px;
    background-color: #f8f9fa;
    border-radius: 8px;
  }

  .stat-item {
    display: flex;
    flex-direction: column;
    align-items: center;
  }

  .stat-item strong {
    font-size: 36px;
    color: #007bff;
    margin-bottom: 5px;
  }

  .stat-item span {
    color: #666;
    font-size: 14px;
  }

  .modal-actions {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-top: 20px;
  }

  .button-large {
    font-size: 18px;
    padding: 14px 32px;
  }

  .button-secondary {
    background-color: #6c757d;
    color: white;
  }

  .button-secondary:hover {
    background-color: #5a6268;
  }
  
  .modal {
    display: none;
    position: fixed;
    z-index: 1000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
  }
  
  .modal-content {
    background-color: white;
    margin: 10% auto;
    padding: 30px;
    border-radius: 8px;
    max-width: 500px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
  }
  
  .modal-content h3 {
    margin: 0 0 10px 0;
    color: #333;
  }
  
  .modal-content p {
    color: #666;
    margin-bottom: 20px;
  }
  
  .feedback-form {
    margin-bottom: 15px;
  }

  .feedback-options {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }
  
  .feedback-button {
    background: white;
    border: 2px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    cursor: pointer;
    transition: all 0.3s;
    text-align: left;
    width: 100%;
  }
  
  .feedback-button:hover {
    border-color: #007bff;
    background-color: #f8f9fa;
  }
  
  .feedback-button strong {
    display: block;
    font-size: 16px;
    color: #333;
    margin-bottom: 4px;
  }
  
  .feedback-button small {
    color: #666;
    font-size: 13px;
  }
</style>

<script>
  function handleNextDay() {
    <% if @current_meal_plan && !@current_meal_plan.completed? %>
      const currentDay = <%= @current_day_number %>;
      const totalDays = <%= @total_days %>;
      
      if (currentDay === totalDays) {
        showCompletionModalForLastDay();
      } else {
        showFeedbackModal();
      }
    <% end %>
  }
  
  function showFeedbackModal() {
    document.getElementById('feedbackModal').style.display = 'block';
  }
  
  function hideFeedbackModal() {
    document.getElementById('feedbackModal').style.display = 'none';
  }
  
  function showCompletionModalForLastDay() {
    <% if @current_meal_plan %>
      const form = document.createElement('form');
      form.method = 'POST';
      form.action = '<%= advance_day_meal_plan_path(@current_meal_plan) %>';
      
      const csrfToken = document.createElement('input');
      csrfToken.type = 'hidden';
      csrfToken.name = 'authenticity_token';
      csrfToken.value = '<%= form_authenticity_token %>';
      
      const feedback = document.createElement('input');
      feedback.type = 'hidden';
      feedback.name = 'feedback';
      feedback.value = 'strictly_followed';
      
      form.appendChild(csrfToken);
      form.appendChild(feedback);
      document.body.appendChild(form);
      form.submit();
    <% end %>
  }
  
  function hideCompletionModal() {
    const modal = document.getElementById('completionModal');
    if (modal) {
      modal.style.display = 'none';
    }
  }
  
  function closeAndRedirect() {
    window.location.href = '<%= root_path %>';
  }
  
  window.onclick = function(event) {
    const feedbackModal = document.getElementById('feedbackModal');
    const completionModal = document.getElementById('completionModal');
    
    if (event.target == feedbackModal) {
      hideFeedbackModal();
    }
    
    if (event.target == completionModal) {
      hideCompletionModal();
    }
  }
  
  <% if @just_completed && @current_meal_plan&.completed? %>
    window.addEventListener('DOMContentLoaded', function() {
      const modal = document.getElementById('completionModal');
      if (modal) {
        modal.style.display = 'block';
      }
    });
  <% end %>
</script>
